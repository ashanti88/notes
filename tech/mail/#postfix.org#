#+TAGS: mail mta


* postfix							   :mail:mta:
* Description
* Files
/etc/postfix/main.cf
* Usage
** Basic Admin
- View Mail Queue
#+BEGIN_SRC sh
postqueue -p
#+END_SRC
or
#+BEGIN_SRC sh
mailq
#+END_SRC

- Show default postfix values
#+BEGIN_SRC sh
postconf -d
#+END_SRC

- Show non default
#+BEGIN_SRC sh
postconf -n
#+END_SRC
postfix values

- list mail queue and MAIL ID's
#+BEGIN_SRC sh
postcat -q $MAIL_ID
#+END_SRC
*** postsuper
- To remove MAIL\_ID mail from the queue
#+BEGIN_SRC sh
postsuper -d $MAIL_ID
#+END_SRC

- To remove all mail from the queue
#+BEGIN_SRC sh
postsuper -d ALL
#+END_SRC

- To remove all mails in the deferred queue
#+BEGIN_SRC sh
postsuper -d ALL deferred
#+END_SRC

*** postqueue
- list mail queue
#+BEGIN_SRC sh
postqueue -p
#+END_SRC

- Flush mail queue
#+BEGIN_SRC sh
postqueue -f
#+END_SRC

- Sort and count emails by "from address"
#+BEGIN_SRC sh
postqueue -p | awk '{print $7}' | sort | uniq -c | sort -n
#+END_SRC

- removing all emails sent by: [[mailto:user@adminlogs.info][user@adminlogs.info]]
#+BEGIN_SRC sh
postqueue -p | grep ' [2]'|grep user@adminlogs.info|cut -f1 -d' ' |tr -d |postsuper -d -
#+END_SRC

- Remove all email sent from [[mailto:user@adminlogs.info][user@adminlogs.info]]
#+BEGIN_SRC sh
postqueue -p | awk {print $1}' | cut -d '!' -f 1 | postsuper -d -
#+END_SRC

- To delete all messages from the queue by a certain user: for i in
#+BEGIN_SRC sh
postqueue -p | grep[user@domain.com](mailto:user@domain.com) | awk '{print $1}' | grep -v host | grep -v do postsuper -d $i; done
#+END_SRC

- Remove all email sent by domain adminlogs.info
#+BEGIN_SRC sh
postqueue -p | grep ' [4]'|grep @adminlogs.info|cut -f1 -d' ' |tr -d | postsuper -d -      //
#+END_SRC

- Mail queue stats short
#+BEGIN_SRC sh
postqueue -p | tail -n 1
#+END_SRC

- Number of emails in Mail queue
#+BEGIN_SRC sh
postqueue -p | grep -c
#+END_SRC

- Watch logs live
#+BEGIN_SRC sh
tail -f /var/log/maillog
#+END_SRC

*** System V
- Reload Configuration
#+BEGIN_SRC sh
service postfix reload
#+END_SRC

- Restart Postfix Server
#+BEGIN_SRC sh
service postfix restart
#+END_SRC

- View the postfix version
#+BEGIN_SRC sh
postconf mail version
#+END_SRC

*** Systemd
Reload
#+BEGIN_SRC sh
systemctl reload postfix.service
#+END_SRC

Start
#+BEGIN_SRC sh
systemctl start postfix.service
#+END_SRC

Stop
#+BEGIN_SRC sh
systemctl stop postfix.service
#+END_SRC

* Lecture
* Tutorial
* Books
[[file://home/crito/Documents/SysAdmin/Mail/Postfix-The_Definitive_Guide.pdf][Postfix - The Definitive Guide - O'Reilly]]
** [[file://home/crito/Documents/SysAdmin/Mail/The_Book_of_Postfix_No_Starch.pdf][The Book of Postfix - No Starch]]
*** Chapter 2
[[file://home/crito/Documents/RFC/rfc821.pdf][RFC 821 - SMTP]]
- Initial Checklist
  - set hostname correctly
    - [[file://home/crito/org/tech/cmds/hostname.org][hostname]]
  - verify your hosts connectivity
    - use a host independent of the smtp server
    - makesure port 25 is added to FW rules
  - maintain a reliable system time
    - an NTP server needs to be installed due to OS time drift
  - make sure that systme logging can record Postfix diagnostics
    - this aspect is dependent on the system
      - sysv
      - sysd
  - configure name resolution for the client 
  - configure dns records for the mail server
    - [[file://home/crito/org/tech/cmds/dig.org][dig - used to discover DNS records]]
    - multiple mx records can be set, with the lowest priority taking precedence
      
*** Chapter 3
- Single Domain Configuration
  1. Configure Postfix to greet mail clients with the correct hostname
     - this can be set in the /etc/postfix/main.cf
       - add the FDQN here
       - myhostname = mail.example.com
  2. Configure Postfix to accept mail for the domain example.com
     - this can be set in the /etc/postfix/main.cf
       - add the domain name
       - mydomain = example.com
     - either the hostname or the domain need to be set (both aren't needed)
  3. Configure Postfix to append example.com to mail sent with a bare username
  4. Configure Postfix to deliver mail addressed to root to a different mailbox
     - /etc/postfix/aliases - in here root can be set too admin
     - root: admin
       - admin: root - will have to be deleted otherwise a loop will be created
  5. Configure Postfix to deliver mail sent to email addresses to the appropriate username
  6. Set permissions to make Postfix relay email from your network 

- Sending test mail
1. send via the sendmail binary
#+BEGIN_SRC sh
echo foo | /usr/bin/sendmail -f root root && tail -f /var/log/maillog
#+END_SRC
This will send the text foo to root with an envelope sender of root, and it will print the mail devilry log to confirm delivery status

2. Sending mail from the cmd line
#+BEGIN_SRC sh
mail admin
#+END_SRC
This will then prompt for subject press ret, and the enter the message, the a newline with a period to send the message

3. Sending mail with telnet over port 25
#+BEGIN_SRC sh
telnet mail.example.com 25
HELO client.example.com
MAIL FROM: <test@client.example.com>
RCPT TO: <root@example.com>
DATA
Test mail from a telnet session
.
QUIT
#+END_SRC

- Creatin Aliases
John Doe has an 
auth user: John 
and he needs mail 
user accounts:
  john@example.com
  john.doe@example.com
  doe@example.com
group account
  sales@example.com
- edit /etc/postfix/aliases to look like below
[[file://home/crito/Pictures/org/postfix_aliases.png]]
- update aliases.db file 
#+BEGIN_SRC sh
postalias hash:/etc/postfix/aliases
#+END_SRC
or
#+BEGIN_SRC sh
newaliases
#+END_SRC

* Links


