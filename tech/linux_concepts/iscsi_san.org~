#+TAGS:


* iSCSI SAN
* Cmds
- [[file://home/crito/org/tech/cmds/lvscan.org][lvscan]]
- [[file://home/crito/org/tech/cmds/lvcreate.org][lvcreate]]
- file://home/crito/org/tech/cmds/iscsiadm.org



* Description
* How
** Setting up the iSCSI SAN
1. check block device|partition, decide which device is to be used as the SAN
2. place this device into the volume group that will be used by the SAN 
- vgcreate
- vgscan
3. create the logical groups in the volume group
- lvcreate
- lvscan
4. install the iSCSI software
#+BEGIN_SRC sh
yum -y install targetcli
#+END_SRC

5. Add storage to targetcli 
i)   Enter targetcli on the cmd line this will drop you into an interactive shell
ii)  Move to the /backstores
iii) Create the SAN store
using block device
#+BEGIN_EXAMPLE
/backstores> block/ create block1 /dev/vgsan/lvsan1
#+END_EXAMPLE
here we are saying create "block1" and add lvsan1 to this SAN store

using file
#+BEGIN_EXAMPLE
/backstores> fileio/ create file1 /root/diskfile1 1G
#+END_EXAMPLE
if the file is not created, target will create it

iv)  Create iSCSI targets
#+BEGIN_EXAMPLE
/> cd iscsi
/iscsi> create iqn.2017-10.com.example:target1
#+END_EXAMPLE

v)  Configure the new target
#+BEGIN_EXAMPLE
cd iqn.2017-10.com.example:target1/
cd tpg1/
acls/ create iqn.2017-10.com.example:server2
luns/ create /backstores/block1
luns/ create /backstores/block2
luns/ create /fileio/file1
#+END_EXAMPLE
always create acl before the lun, as default behaviour is to assign luns to the created acl

vi) Configure the portals
#+BEGIN_EXAMPLE
/iscsi/iqn.2017-10...:target1/tpg1> portals/ create 192.168.4.101
#+END_EXAMPLE
this is the ip address that can connect to the SAN (default port is 3260)

vii) Configure the FW
#+BEGIN_SRC sh
firewall-cmd --add-port=3260/tcp --permanent
firewall-cmd reload
#+END_SRC

viii) Start and enable target service
#+BEGIN_SRC sh
systemctl enable target
systemctl start target
#+END_SRC

** Setting up the Connecting Server 
i)  First install the software
#+BEGIN_SRC sh
yum install -y iscsi-initiator-utils
yum install -y lsscsi
#+END_SRC

ii) Set the initiator name
/etc/iscsi/initiatorname.iscsi
#+BEGIN_EXAMPLE
InitiatorName=iqn.2017-10.com.example:server2
#+END_EXAMPLE

iii) Discover the SAN
#+BEGIN_SRC sh
iscsiadm --mode discoverydb --type sendtargets --portal 192.168.4.101 --discover
#+END_SRC
this will discover all targets on the sepcified ip address

iv)  Login to the found target
#+BEGIN_SRC sh
iscsiadm --mode node --targetname iqn.2017-10.com.example:target1 --portal 192.168.4.101 --login
#+END_SRC

v)  Confirm that the SAN is connected
#+BEGIN_SRC sh
lsscsi
#+END_SRC
this should show the SAN devices|files etc

vi) viewing the new iSCSI configuration created by this process
/var/lib/iscsi/nodes/iqn.2017-10.com.example:target1/default
This file is automatically created and contains all of the configrable options for the SAN

* Terminology
IQN       - iSCSI Qualified Name, a unique name used for identifying targets as well as initiators
Initiator - iSCSI client that is identified by an IQN
Target    - the service on an iSCSI server that gives access to the backend storage devices
ACL       - Access Control List that is based on node IQN's
portal    - the ip address and port that a target or initiator uses to establish connections
discovery - the process where an initiator finds the target that are configured on a portal
LUN       - the block devices shared through the target
login     - authentication that gives an initiator access to LUNs
TPG       - Target Portal Group, the collection of IP addresses and TCP ports to which a specific iSCSI target will listen 


* Lecture
* Tutorial
* Books
* Links
