#+TAGS: sys boot


* Grub2                                                            :sys:boot:
Manual: [[https://www.gnu.org/software/grub/manual/grub.html][gnu.org/grub]]
Manual: [[https://www.gnu.org/software/grub/manual/grub.html][gnu.org]]
* Overview
* Cmds
- grub2-mkconfig

* Files
/boot/grub/grubenv - this shows the default kernel to be booted
/boot/grub/grub.cfg - this file is automatically created from /etc/grub.d/ and /etc/default/grub
/etc/default/grub - this contains the options used to create the grub.cfg
/etc/grub.d/ - the files in here are used to build the grub.cfg file, they indicate individual kernels and OSs

* Usage
** Grub Shell
*** Cmds
- setting the pager
grub> set pager=1

- view what partitions are available
  
** Booting into runlevel one (sysv)                        :boot:sysv:rescue:
- setting runlevel one
1. open boot config by pressing 'e'

[[file://home/crito/Pictures/org/grub_runlevel_01.png]]

2. Edit the line that starts with linux and add a 1 to the end. Then press Ctrl-x to boot 
   
[[file://home/crito/Pictures/org/grub_runlevel_02.png]]

3. This will now drop you into runlevel 1, system will prompt you for the root password
   
[[file://home/crito/Pictures/org/grub_runlevel_03.png]]

4. Once changes/rescue has been completed move to runlevel 5 (multi-user).

** Booting into emergency mode (sysd)                      :boot:sysd:rescue:
Emergency mode runs the most minimal environment, the system mounts the root file system as read-only, does not not mount any other file systems and does not activate any network interfaces.
1. Edit boot by typing 'e'

[[file://home/crito/Pictures/org/grub_runlevel_01.png]]

2. Add the following parameter systemd.unit=emergency.target to the line that starts with linux
   
[[file://home/crito/Pictures/org/grub_runlevel_04.png]]

3. Press ctrl-x to boot the system
   
** Booting into rescue mode (sysd)                         :boot:sysd:rescue:
This is equivalent to sysv single user mode and requires root password. Rescue mode will attempt to mount all local file systems and will start the important services, but will not bring up networking interfaces.
There are two methods
*** Method One
1. At the grub menu you are provided with the rescue option

[[file://home/crito/Pictures/org/grub_runlevel_05.png]]

*** Method Two
1. At grub type 'e' and this will allow you to edit boot options

[[file://home/crito/Pictures/org/grub_runlevel_01.png]]

2. Edit the line that starts with linux and add the parameter systemd.unit=rescue.target 

[[file://home/crito/Pictures/org/grub_runlevel_06.png]]

3. Ctrl+x will prompt for root password
   
[[file://home/crito/Pictures/org/grub_runlevel_07.png]]

** Changing the default kernel
/boot/grub/grubenv - this shows which kernel is currently being booted

1. Query which kernels and OSs are available
- Arch, Manjaro
#+BEGIN_SRC sh
awk -F\' /^menuentry/{print\$2} /boot/grub/grub.cfg
#+END_SRC

- CentOS/RHEL
#+BEGIN_SRC sh
awk -F\' /^menuentry/{print\$2} /etc/grub2.cfg
#+END_SRC
This will print out all available options (numbering starts from 0)

2. Selecting a new boot option
#+BEGIN_SRC sh
grub-set-default 1
#+END_SRC
This will select the second line printed with above command as the default boot option

3. Confirm the defualt option has been selected
#+BEGIN_SRC sh
cat /boot/grub/grubenv
#+END_SRC
This will show the new option as the saved_entry=<new_option>

4. Reboot system for change to take effect

** Adding a new kernel to the conf
#+BEGIN_SRC sh
grub-mkconfig -o /boot/grub/grub.cfg
#+END_SRC
This will rebuild the configuration
* Lecture
* Tutorial
* Books
* Links
[[https://www.linux.com/learn/how-rescue-non-booting-grub-2-linux][How to Rescue a Non-Booting GRUB 2 on Linux]]
[[https://opensource.com/article/17/3/introduction-grub2-configuration-linux?sc_cid=70160000001273HAAQ][An Introduction to GRUB2 configuration for your Linux machine]]
