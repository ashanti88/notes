#+TAGS: ftp


* ftp									:ftp:
* Usage
** Commands
- abor - abort an active file transfer
- acct - account information
- adat - authentication/security data
- allo - allocate sufficient disk space to receive a file
- appe - append
- auth - authentication/security mechanism
- ccc  - clear command channel
- cdup - change to parent directory
- conf - confidentiality protection command
- cwd  - change working directory
- dele - delete file
- enc  - privacy protected channel
- eprt - specifies an extended address and port to which the server should connect
- epsv - enter extended passive mode
- feat - get the feature list implemented by the server
- help - returns cmd specific help is supplied, otherwise general help
- host - identify desired virtual host on server, by name
- lang - language negotiation
- list - returns information of a file or directory
- lprt - specifies a long address and port to which the server should connect
- lpsv - enter long passive mode
- mdtm - return the last-modified time of a specified file
- mic  - integrity proctected command
- mkd  - make directory
- mlsd - list the contents of a directory if a directory is named
- mlst - provides data about exactly the object named on its command line, and no others
- mode - sets the transfer mode (stream, block or compressed)
- nlst - return a list of files in a named directory
- noop - no operation (usually used for keep a live)
- opts - select options for a feature
- pass - authentication password
- pasv - enter passive mode
- pbsz - protection buffer size
- port - specifies an address and port to which server should connect
- prot - data channel protection level
- pwd  - print working directory
- quit - disconnect
- rein - re-initialise connection
- rest - restart transfer from specified point
- retr - retrieve a copy of the file
- rmd  - remove a directory
- rnfr - rename from
- rnto - rename to
- site - sends site specific cmds to remote server
- size - return the size of a file
- smnt - mount file structure
- stat - return the current status
- stor - accept the data and to store the data as a file server side
- stou - store file uniquely
- stru - set file transfer structure 
- syst - return system type
- type - sets the transfer mode
- user - authentication username
- xcup - change to the parent of the current working directory
- xmkd - make a directory
- xpwd - print the current working directory
- xrmd - remove the directory
- xsem - send, mail if cannot
- xsen - send to terminal

** Server Return Codes
[[https://en.wikipedia.org/wiki/List_of_FTP_server_return_codes][URL: wiki - FTP Server Return Codes]]
1xx - Positive Preliminary reply
2xx - Positive Completion reply
3xx - Positive Intermediate reply
4xx - Transient Negative Completion reply
5xx - Permanent Negative Completion reply
6xx - Protected reply

** How To's
*** Adding FTP user						     :ftp:op:
> useradd -d /path/to -s /sbin/nologin <new_ftp_user>
*** Adding SSH/SFTP user
> useradd -d /home/www -s /bin/bash fgray

*** Change Password for user (also used when setting up user first time)
> passwd <ftp_user>

*** Changing users start directory
usermod -d /newdir/location whateverusername


*New FileZilla bullshit default over TLS thing*

* Monitoring							   :ftp:anal:
** Checking for FTP Brute force in the logs*
grep 'Jun  6' /var/log/secure | awk '{print $7}' | sort | uniq -c | sort
-gr | head -10

grep 'Failed' /var/log/secure | awk '{print $13}' | sort | uniq -c |
sort -gr | head -10 | awk '{ printf("%5d\t%-15s\t", $1, $2);
system("geoiplookup " $2 " | head -1 | cut -d \: -f2 ") }'

grep 'Failed' /var/log/secure | awk '{print $11}' | sort | uniq -c |
sort -gr | head -10 | awk '{ printf("%5d\t%-15s\t", $1, $2);
system("geoiplookup " $2 " | head -1 | cut -d \: -f2 ") }'

grep 'no such user found' /var/log/secure | awk '{print $13}' | sort |
uniq -c | sort -gr | head -10

grep 'no such user found' /var/log/secure | awk '{print $16}' | sort |
uniq -c | sort -gr | head -10 | awk '{ printf("%5d\t%-15s\t", $1, $2);
system("geoiplookup " $2 " | head -1 | cut -d \: -f2 ") }'

grep 'Authentication failed for user' /var/log/messages* | awk '{print
$6}' | cut -d '@' -f2 | cut -d ')' -f1 | sort | uniq -c | sort -gr |
head -10 | awk '{ printf("%5d\t%-15s\t", $1, $2); system("geoiplookup "
$2 " | head -1 | cut -d \: -f2 ") }'

grep 'Failed password for' /var/log/secure | awk '{print $11}' | cut -d
'@' -f2 | cut -d ')' -f1 | sort | uniq -c | sort -gr | head -10 | awk '{
printf("%5d\t%-15s\t", $1, $2); system("geoiplookup " $2 " | head -1 |
cut -d \: -f2 ") }'

* Pure-ftpd
URL: [[https://www.pureftpd.org/project/pure-ftpd][Home Page]]
* vsftpd
URL: [[https://security.appspot.com/vsftpd.html][Home Page]]
** Configuration
- File - /etc/vsftpd.conf
- examples can be found in /usr/share/doc/vsftpd/EXAMPLES
- there are three types in the configuration files
  - BOOLEAN OPTIONS
  - NUMERIC OPTIONS
  - STRING OPTIONS
    
*** Anonymous Options
- Anonymous access - by default this is turned off
  anonymous_enable=YES
- if this option is enabled only /srv/ftp/ is allowed to be accessed
  anon_mkdir_write_enable - allow directory creation
  anon_root=/path/to/new/dir - change the default root directory
  
*** User Access Control
By default local users are authorized
  local_enable=NO - this disables their access
  write_enable=YES - this enables write access
  
*** User Management
+ Containment of Users
  chroot_local_user=YES
this will mean that users are locked into there home directories

to makesure that ftp user only use ftp and not have shell access
> echo /bin/false >> /etc/shells/
> usermod -s /bin/false <login>

** Trouble-Shooting
500 OOPS: vsftpd: Refusing to run with writable root inside chroot()
*** Solution
1. remove writability to the directory
or
2. allow_writeable_chroot=YES - add to /etc/vsftpd.conf
* Cpanel							 :cpanel:ftp:
** Config
1) Go into /etc/pure-ftpd.conf and uncomment the following line, also restrict the port range:

PassivePortRange 40000 40500
30000 50000

2) Restart the FTP service with the following
/scripts/restartsrv\_ftpd

3) Then open this port range on the firewall and bobs your uncle.

* Plesk								  :plesk:ftp:
